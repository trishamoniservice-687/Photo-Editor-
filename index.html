<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Karim Photo Editor — Multi-line Rotated Watermark</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8}
    *{box-sizing:border-box}
    body{font-family:Inter, 'Noto Sans Bengali', Arial, sans-serif; margin:0; background:linear-gradient(180deg,#071226 0%, #071421 100%); color:#e6eef6; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:28px}
    .app{width:100%; max-width:980px}
    header{display:flex; align-items:center; gap:12px; margin-bottom:18px}
    header h1{font-size:20px; margin:0}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); border-radius:12px; padding:18px; box-shadow:0 6px 24px rgba(2,6,23,0.6)}
    .grid{display:grid; grid-template-columns:360px 1fr; gap:16px}
    .controls{padding:8px}
    label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    input[type=file]{display:block}
    .row{display:flex; gap:8px; align-items:center; margin-bottom:10px}
    textarea, input[type=text], select{width:100%; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:inherit}
    textarea{min-height:64px; resize:vertical}
    .small{font-size:13px}
    .preview{display:flex; flex-direction:column; align-items:center; gap:12px}
    .canvas-wrap{background:#081426; border-radius:8px; padding:10px; display:flex; align-items:center; justify-content:center; min-height:320px}
    canvas{max-width:100%; height:auto; border-radius:6px}
    .btn{background:var(--accent); color:#012; padding:10px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:700}
    .btn.secondary{background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.04)}
    .controls .help{font-size:12px; color:var(--muted); margin-top:6px}
    .footer{display:flex; gap:8px; margin-top:12px}
    .meta{font-size:12px; color:var(--muted)}
    .flex-between{display:flex; justify-content:space-between; align-items:center}
    @media(max-width:900px){.grid{grid-template-columns:1fr;}.card{padding:12px}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><rect rx='8' width='36' height='36' fill='%2306b6d4'/><text x='50%' y='55%' font-size='18' font-family='Arial' font-weight='700' fill='%23001212' text-anchor='middle'>K</text></svg>" alt="logo" style="width:38px;height:38px;border-radius:8px;">
      <h1>Karim Photo Editor — Multi-line Rotated Watermark</h1>
    </header>

    <div class="card grid">
      <div class="controls">
        <label>১) ছবি নির্বাচন করুন</label>
        <input id="fileInput" type="file" accept="image/*">
        <div class="row">
          <button id="btnLoadSample" class="btn secondary">ডেমো ইমেজ লোড করুন</button>
        </div>

        <hr style="opacity:0.06;margin:10px 0">

        <label>২) ওয়াটারমার্ক লেখা (একটি বা একাধিক লাইনে লিখুন — Enter দিয়ে নতুন লাইন)</label>
        <textarea id="wmText" placeholder="উদাহরণ:
Karim
© 2025" rows="3">Karim</textarea>

        <div class="row">
          <div style="flex:1">
            <label class="small">প্রাথমিক ফন্ট সাইজ (px)</label>
            <input id="fontSize" type="range" min="24" max="320" value="80">
          </div>
          <div style="width:120px">
            <label class="small">Opacity</label>
            <input id="opacity" type="range" min="5" max="100" value="30">
          </div>
        </div>

        <div class="row">
          <div style="flex:1">
            <label class="small">ফন্ট নির্বাচন</label>
            <select id="fontSelect">
              <option value="Noto Sans Bengali, sans-serif">Noto Sans Bengali</option>
              <option value="Inter, sans-serif" selected>Inter</option>
              <option value="Arial, sans-serif">System Default</option>
            </select>
          </div>
          <div style="width:140px">
            <label class="small">রিপিট গ্রিড (সর্বনিম্ন 2)</label>
            <input id="repeatCount" type="number" min="2" max="10" value="3" style="width:100%; padding:8px; border-radius:6px; background:transparent; border:1px solid rgba(255,255,255,0.04)">
          </div>
        </div>

        <hr style="opacity:0.06;margin:10px 0">

        <label>৩) KC লোগো সেটিংস</label>
        <div class="row">
          <label class="small" style="flex:1">লোগো সাইজ</label>
          <input id="kcSize" type="range" min="40" max="300" value="120">
        </div>

        <div class="row">
          <label class="small" style="flex:1">লোগো অপাসিটি</label>
          <input id="kcOpacity" type="range" min="0" max="100" value="95">
        </div>

        <div class="footer">
          <button id="applyBtn" class="btn">অ্যাপ্লাই (প্রিভিউ)</button>
          <button id="downloadBtn" class="btn">ডাউনলোড (PNG)</button>
        </div>
      </div>

      <div class="preview">
        <div class="canvas-wrap card">
          <canvas id="previewCanvas" width="800" height="600"></canvas>
        </div>
      </div>
    </div>
  </div>

<script>
// Helper to load local file as Image
function loadImageFromFile(file){
  return new Promise((res, rej)=>{
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = ()=>{ URL.revokeObjectURL(url); res(img); };
    img.onerror = e=>{ URL.revokeObjectURL(url); rej(e); };
    img.src = url;
  });
}

// DOM
const fileInput = document.getElementById('fileInput');
const previewCanvas = document.getElementById('previewCanvas');
const ctx = previewCanvas.getContext('2d');
let currentImage = null;
let naturalW = 0, naturalH = 0;

const wmText = document.getElementById('wmText');
const fontSize = document.getElementById('fontSize');
const opacity = document.getElementById('opacity');
const fontSelect = document.getElementById('fontSelect');
const repeatCount = document.getElementById('repeatCount');
const kcSize = document.getElementById('kcSize');
const kcOpacity = document.getElementById('kcOpacity');
const applyBtn = document.getElementById('applyBtn');
const downloadBtn = document.getElementById('downloadBtn');
const btnLoadSample = document.getElementById('btnLoadSample');

btnLoadSample.onclick = ()=>{
  const img = new Image();
  img.crossOrigin = 'anonymous';
  img.src = 'https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?w=1600&auto=format&fit=crop&q=80';
  img.onload = ()=> setImage(img);
};

fileInput.onchange = async e=>{
  const f = e.target.files?.[0]; if(!f) return;
  const img = await loadImageFromFile(f);
  setImage(img);
};

function setImage(img){
  currentImage = img;
  naturalW = img.naturalWidth || img.width;
  naturalH = img.naturalHeight || img.height;
  const maxW = 880, maxH = 600;
  const ratio = Math.min(maxW/naturalW, maxH/naturalH, 1);
  previewCanvas.width = Math.round(naturalW * ratio);
  previewCanvas.height = Math.round(naturalH * ratio);
  drawPreview();
}

// Core: apply watermarks (supports multi-line input and rotated repeated grid)
function applyWatermarksToCanvas(canvas, image, options){
  const c = canvas; const cctx = c.getContext('2d');
  cctx.clearRect(0,0,c.width,c.height);
  // draw image to full canvas
  cctx.drawImage(image, 0, 0, c.width, c.height);

  // watermark text lines
  const raw = (options.text || '').trim();
  if(!raw) return;
  const lines = raw.split(/
?
/).filter(l=>l.trim().length>0).slice(0,3); // limit to 3 lines

  // compute font size scaled to canvas width
  const baseFont = options.fontSize || 80; // px chosen by user
  const fontPx = Math.max(18, Math.round(baseFont * (c.width / 1000)));
  const fontFamily = options.font || 'Inter, sans-serif';
  const lineHeight = Math.round(fontPx * 1.25);

  // prepare measurement canvas for widest line
  cctx.save();
  cctx.font = `${fontPx}px ${fontFamily}`;
  let maxWidth = 0;
  for(const l of lines){
    const w = cctx.measureText(l).width;
    if(w>maxWidth) maxWidth = w;
  }
  cctx.restore();

  // choose spacing so lines don't overlap — make spacing relative to diagonal bounding box
  // rotated by 45deg expands bounding box by ~sqrt(2)
  const rot = -45 * Math.PI/180;
  const blockW = Math.abs(maxWidth * Math.cos(rot)) + Math.abs(lineHeight * Math.sin(rot));
  const blockH = Math.abs(maxWidth * Math.sin(rot)) + Math.abs(lineHeight * Math.cos(rot)) * lines.length;
  const pad = Math.round(Math.max(blockW, blockH) * 0.6);

  // grid spacing (ensure at least repeatCount rows/cols)
  const repeat = Math.max(2, Number(options.repeat || 3));
  const stepX = Math.max(pad, Math.round(c.width / repeat));
  const stepY = Math.max(pad, Math.round(c.height / repeat));

  // draw rotated watermark grid
  cctx.save();
  cctx.globalAlpha = Math.max(0.02, Math.min(1, (options.opacity||30)/100));
  cctx.textAlign = 'center';
  cctx.textBaseline = 'middle';
  cctx.font = `${fontPx}px ${fontFamily}`;

  // stroke + fill for clarity
  cctx.lineWidth = Math.max(1, Math.round(fontPx * 0.06));
  for(let startY = -stepY; startY < c.height + stepY; startY += stepY){
    for(let startX = -stepX; startX < c.width + stepX; startX += stepX){
      cctx.save();
      cctx.translate(startX + stepX/2, startY + stepY/2);
      cctx.rotate(rot);
      // draw each line stacked vertically centered
      const totalH = (lines.length - 1) * lineHeight;
      for(let i=0;i<lines.length;i++){
        const y = (i * lineHeight) - (totalH/2);
        // shadow/stroke for readability
        cctx.fillStyle = 'rgba(0,0,0,0.45)';
        cctx.fillText(lines[i], 3, y+3);
        cctx.strokeStyle = 'rgba(0,0,0,0.45)';
        cctx.strokeText(lines[i], 0, y);
        cctx.fillStyle = 'rgba(255,255,255,0.95)';
        cctx.fillText(lines[i], 0, y);
      }
      cctx.restore();
    }
  }
  cctx.restore();

  // draw KC logo (top-right)
  drawKCLogo(cctx, c.width, c.height, options.kcSize || 120, (options.kcOpacity||95)/100);
}

function drawKCLogo(cctx, canvasW, canvasH, targetSize, opacityVal){
  const margin = Math.round(targetSize * 0.15);
  const x = canvasW - targetSize - margin;
  const y = margin;
  const off = document.createElement('canvas');
  const dpr = 2;
  off.width = Math.round(targetSize * dpr);
  off.height = Math.round(targetSize * dpr);
  const octx = off.getContext('2d');
  octx.clearRect(0,0,off.width,off.height);
  const center = off.width/2;
  const r = off.width/2;
  const g = octx.createLinearGradient(0,0,off.width,off.height);
  g.addColorStop(0, '#0ea5b8');
  g.addColorStop(1, '#0369a1');
  octx.fillStyle = g;
  octx.beginPath(); octx.arc(center, center, r, 0, Math.PI*2); octx.fill();
  octx.font = `${Math.round(off.width*0.45)}px Inter, sans-serif`;
  octx.textAlign = 'center'; octx.textBaseline = 'middle';
  octx.fillStyle = 'rgba(0,0,0,0.35)'; octx.fillText('KC', center+3, center+4);
  octx.fillStyle = '#fff'; octx.fillText('KC', center, center);
  octx.strokeStyle = 'rgba(255,255,255,0.18)'; octx.lineWidth = Math.max(1, off.width*0.02); octx.strokeText('KC', center, center);
  cctx.save(); cctx.globalAlpha = opacityVal; cctx.drawImage(off, 0,0, off.width, off.height, x, y, targetSize, targetSize); cctx.restore();
}

// preview: draw onto a temporary full-size canvas then scale down to previewCanvas
function drawPreview(){
  if(!currentImage){ ctx.clearRect(0,0,previewCanvas.width,previewCanvas.height); ctx.fillStyle='#071223'; ctx.fillRect(0,0,previewCanvas.width,previewCanvas.height); return; }
  const tmp = document.createElement('canvas'); tmp.width = naturalW; tmp.height = naturalH;
  applyWatermarksToCanvas(tmp, currentImage, {
    text: wmText.value,
    font: fontSelect.value,
    fontSize: Number(fontSize.value),
    opacity: Number(opacity.value),
    repeat: Number(repeatCount.value),
    kcSize: Number(kcSize.value),
    kcOpacity: Number(kcOpacity.value)
  });
  ctx.clearRect(0,0,previewCanvas.width,previewCanvas.height);
  ctx.drawImage(tmp, 0,0, tmp.width, tmp.height, 0,0, previewCanvas.width, previewCanvas.height);
}

applyBtn.onclick = ()=>{ if(!currentImage) return alert('দয়া করে আগে ছবি আপলোড করুন'); drawPreview(); };
[wmText,fontSize,opacity,fontSelect,repeatCount,kcSize,kcOpacity].forEach(el=>el.addEventListener('input', ()=>{ if(currentImage) drawPreview(); }));

// download final at natural resolution
downloadBtn.onclick = ()=>{
  if(!currentImage) return alert('দয়া করে আগে ছবি আপলোড করুন');
  const final = document.createElement('canvas'); final.width = naturalW; final.height = naturalH;
  applyWatermarksToCanvas(final, currentImage, {
    text: wmText.value,
    font: fontSelect.value,
    fontSize: Number(fontSize.value),
    opacity: Number(opacity.value),
    repeat: Number(repeatCount.value),
    kcSize: Math.round(Number(kcSize.value) * (naturalW / previewCanvas.width)),
    kcOpacity: Number(kcOpacity.value)
  });
  final.toBlob(function(blob){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='karim_edited.png'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href); }, 'image/png');
};

// initial empty draw
ctx.fillStyle='#071223'; ctx.fillRect(0,0,previewCanvas.width,previewCanvas.height);
</script>
</body>
</html>
